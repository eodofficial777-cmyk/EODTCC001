/**
 * Core Philosophy: This ruleset enforces a mixed security model tailored for a role-playing game application.
 * It combines a strict user-ownership model for player-specific data with a global read-only model for common game data.
 * Administrative privileges are managed via a database-as-access-control (DBAC) collection.
 *
 * Data Structure: Player-specific data, such as user profiles, characters, and task submissions, is nested
 * under the `/users/{userId}` path. This structure leverages path-based security to ensure players can only
 * access their own information. Global game data, like factions, races, items, and skills, is stored in
 * top-level collections, making it easily accessible for all clients.
 *
 * Key Security Decisions:
 * - User Data Privacy: All documents under `/users/{userId}` are strictly private and can only be accessed by the owning user.
 * - Public Game Data: Core game assets (items, factions, skills, etc.) are publicly readable to allow the client application
 *   to function correctly. However, all write operations on this data are restricted to administrators.
 * - Admin Roles: A user is considered an administrator if a document with their UID exists in the `/roles_admin` collection.
 *   This DBAC approach avoids custom claims and allows for dynamic role management.
 * - No User Listing: Listing the entire `/users` collection is explicitly forbidden to protect user privacy.
 * - Denormalization for Authorization: User-owned documents (like Characters and Tasks) are expected to contain a `userId` field
 *   that matches the `userId` in the path. This is validated on creation and enforced as immutable on update, ensuring
 *   relational integrity without costly `get()` calls in rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     * This is the foundation of the user-ownership model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the current user has administrative privileges.
     * This is determined by the existence of their UID in the /roles_admin collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * Combines owner check with an existence check for update/delete operations.
     * This prevents modifying or deleting documents that do not exist.
     */
    function isOwnerOfExistingDoc(userId) {
      return isOwner(userId) && resource != null;
    }
    
    /**
     * Validates that an incoming user-owned document contains a `userId` field
     * that correctly links it back to the owner.
     */
    function hasCorrectUserId(userId) {
      return request.resource.data.userId == userId;
    }
    
    /**
     * Ensures that the `userId` field on a user-owned document cannot be changed
     * after it has been created.
     */
    function isUserIdImmutable() {
      return request.resource.data.userId == resource.data.userId;
    }

    // ----------------------------------------------------------------------
    // User Data Collections
    // ----------------------------------------------------------------------

    /**
     * @description Manages user account information.
     * @path /users/{userId}
     * @allow (create) An authenticated user creating their own user profile document.
     * @deny (list) A user trying to list all other users in the application.
     * @principle A user can create their own profile, which can then only be managed by themselves or an admin.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if (isOwner(userId) || isAdmin()) && resource != null;
      allow delete: if (isOwner(userId) || isAdmin()) && resource != null;
    }

    /**
     * @description Manages characters belonging to a specific user.
     * @path /users/{userId}/characters/{characterId}
     * @allow (create) The owning user creating a new character for their account.
     * @deny (get) A different user trying to read another user's character data.
     * @principle Restricts all access to a user's own data tree, enforcing strict ownership.
     */
    match /users/{userId}/characters/{characterId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && hasCorrectUserId(userId);
      allow update: if isOwnerOfExistingDoc(userId) && isUserIdImmutable();
      allow delete: if isOwnerOfExistingDoc(userId);
    }

    /**
     * @description Manages tasks submitted by a specific user.
     * @path /users/{userId}/tasks/{taskId}
     * @allow (list) The owning user listing all tasks they have submitted.
     * @deny (create) A user trying to submit a task on behalf of another user.
     * @principle Restricts all access to a user's own data tree, enforcing strict ownership.
     */
    match /users/{userId}/tasks/{taskId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && hasCorrectUserId(userId);
      allow update: if isOwnerOfExistingDoc(userId) && isUserIdImmutable();
      allow delete: if isOwnerOfExistingDoc(userId);
    }

    // ----------------------------------------------------------------------
    // Global Game Data Collections (Public Read, Admin Write)
    // ----------------------------------------------------------------------

    /**
     * @description Stores global faction information.
     * @path /factions/{factionId}
     * @allow (get, list) Any user, including unauthenticated ones, reading faction data.
     * @deny (create) A non-administrative user attempting to create a new faction.
     * @principle Data is public for client use, but mutable only by administrators.
     */
    match /factions/{factionId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Stores global race information.
     * @path /races/{raceId}
     * @allow (get, list) Any user, including unauthenticated ones, reading race data.
     * @deny (update) A non-administrative user attempting to modify a race.
     * @principle Data is public for client use, but mutable only by administrators.
     */
    match /races/{raceId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Stores definitions for different types of tasks.
     * @path /taskTypes/{taskTypeId}
     * @allow (get, list) Any user, including unauthenticated ones, reading task type data.
     * @deny (delete) A non-administrative user attempting to delete a task type.
     * @principle Data is public for client use, but mutable only by administrators.
     */
    match /taskTypes/{taskTypeId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Stores information about all available items in the game.
     * @path /items/{itemId}
     * @allow (get, list) Any user, including unauthenticated ones, reading item data.
     * @deny (create) A non-administrative user attempting to create a new item.
     * @principle Data is public for client use, but mutable only by administrators.
     */
    match /items/{itemId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Stores definitions for different types of items.
     * @path /itemTypes/{itemTypeId}
     * @allow (get, list) Any user, including unauthenticated ones, reading item type data.
     * @deny (update) A non-administrative user attempting to modify an item type.
     * @principle Data is public for client use, but mutable only by administrators.
     */
    match /itemTypes/{itemTypeId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Stores information about all available equipment in the game.
     * @path /equipment/{equipmentId}
     * @allow (get, list) Any user, including unauthenticated ones, reading equipment data.
     * @deny (delete) A non-administrative user attempting to delete a piece of equipment.
     * @principle Data is public for client use, but mutable only by administrators.
     */
    match /equipment/{equipmentId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Stores information about combat encounters.
     * @path /combatEncounters/{combatEncounterId}
     * @allow (get, list) Any user, including unauthenticated ones, reading encounter data.
     * @deny (create) A non-administrative user attempting to create a new encounter.
     * @principle Data is public for client use, but mutable only by administrators.
     */
    match /combatEncounters/{combatEncounterId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Stores log data for a specific combat encounter.
     * @path /combatEncounters/{combatEncounterId}/combatLogs/{combatLogId}
     * @allow (get, list) Any user, including unauthenticated ones, reading combat logs.
     * @deny (create) A non-administrative user attempting to add a combat log.
     * @principle Data is public for client use, but mutable only by administrators.
     */
    match /combatEncounters/{combatEncounterId}/combatLogs/{combatLogId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Stores information about all available titles/achievements.
     * @path /titles/{titleId}
     * @allow (get, list) Any user, including unauthenticated ones, reading title data.
     * @deny (update) A non-administrative user attempting to modify a title.
     * @principle Data is public for client use, but mutable only by administrators.
     */
    match /titles/{titleId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Stores associations linking characters to titles they have earned.
     * @path /characterTitles/{characterTitleId}
     * @allow (get, list) Any user, including unauthenticated ones, reading character-title links.
     * @deny (create) A non-administrative user attempting to grant a title to a character.
     * @principle Data is public for client use, but mutable only by administrators.
     */
    match /characterTitles/{characterTitleId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Stores information about all available skills in the game.
     * @path /skills/{skillId}
     * @allow (get, list) Any user, including unauthenticated ones, reading skill data.
     * @deny (delete) A non-administrative user attempting to delete a skill.
     * @principle Data is public for client use, but mutable only by administrators.
     */
    match /skills/{skillId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    // ----------------------------------------------------------------------
    // Administrative Collections
    // ----------------------------------------------------------------------
    
    /**
     * @description Manages user administrative roles. The existence of a document grants admin privileges.
     * @path /roles_admin/{userId}
     * @allow (create, delete) An existing admin granting or revoking admin rights for another user.
     * @deny (list) A non-admin attempting to list all administrators.
     * @principle Implements Database-as-Access-Control (DBAC) for managing roles.
     */
    match /roles_admin/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
  }
}
